CREATE OR REPLACE PROCEDURE SP_CHECK_AVGSAL (P_EMPID NUMBER)AS

CURSOR CUR_SALARY IS SELECT JOB_ID,SALARY FROM EMP WHERE EMPLOYEE_ID=P_EMPID;

V_COUNT NUMBER;

EMP_NOT_EXIST EXCEPTION;

ROW_LOCKED EXCEPTION;
PRAGMA EXCEPTION_INIT(ROW_LOCKED,-54);

BEGIN

FOR C1 IN(SELECT * FROM EMP WHERE EMPLOYEE_ID=P_EMPID FOR UPDATE NOWAIT) LOOP
NULL;
END LOOP;

SELECT COUNT(*) INTO V_COUNT FROM EMP WHERE EMPLOYEE_ID=P_EMPID;

IF V_COUNT=0 THEN
RAISE  EMP_NOT_EXIST;
END IF;

FOR REC IN CUR_SALARY LOOP

IF REC.SALARY > SF_GET_JOB_AVGSAL (REC.JOB_ID) THEN

UPDATE EMP SET EXCEED_AVGSAL = 'YES' WHERE EMPLOYEE_ID=P_EMPID;
COMMIT;

END IF;
END LOOP;

EXCEPTION
WHEN ROW_LOCKED THEN
DBMS_OUTPUT.PUT_LINE('ERR-0105 : ROW LOCKED');

WHEN EMP_NOT_EXIST THEN
ROLLBACK;
DBMS_OUTPUT.PUT_LINE('ERR-0102, EMPLOYEE DOES NOT EXIST');
END;
/
SHOW ERRORS;